

<!DOCTYPE html>
<html class="writer-html5" lang="ja" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>コード解説（インターフェース) &mdash; Dronedoc 1.0.0 ドキュメント</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  
    <link rel="canonical" href="https://uenota.github.io/dronedoc/moveit/drive_drone/ctrl_interface.html" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Dronedoc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SLAM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../px4sim/px4sim.html">PX4 SITLシミュレーション</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodecpp.html">自作ノードを実行する（C++）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodepy.html">自作ノードを実行する（Python）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../addmodel/addmodel.html">新しいモデルを追加する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/slam.html">自律飛行とSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/gps_nav.html">GPSを用いた自律飛行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/turtle_mapping.html">Turtlebotを使ってマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../teleop/teleop.html">ゲームパッドを使ってドローンを操作する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_localization.html">LiDARとAMCLを用いた自己位置推定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/localization_and_mapping.html">LiDARを用いたSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_nav.html">LiDARを用いた自律移動</a></li>
</ul>
<p class="caption"><span class="caption-text">Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../octomap/octomap.html">Octomapを使って3Dマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gmapping/build_map_gmapping.html">Gmappingを使って地図を生成する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gazebo_plugin/build_map_gazebo_plugin.html">Gazebo Pluginを使って地図を作成する</a></li>
</ul>
<p class="caption"><span class="caption-text">Motion Planning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">MoveIt!を使ってドローンの経路計画を行う</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../local_planner_for_uav/local_planner_for_uav.html">UAV用のローカルプランナを実装する</a></li>
</ul>
<p class="caption"><span class="caption-text">Tips</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../qgc_intro/qgc_intro.html">QGroundControl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../add_range_sensor/add_range_sensor.html">ドローンに距離センサを搭載する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filter_lidar/filter_lidar.html">LiDARのデータをフィルタリングする</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../change_local_planner/change_local_planner.html">move_baseのローカルプランナーを変更する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../airsim/airsim.html">AirSimシミュレータを使う</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/bash_commands/bash_commands.html">基本的なBashの使い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/ros/ros.html">ROSの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/terms/terms.html">用語集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/archive/archive.html">読書案内</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/trouble_shooting/index.html">トラブルシューティング</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dronedoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>コード解説（インターフェース)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/moveit/drive_drone/ctrl_interface.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>コード解説（インターフェース)<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">follow_multi_dof_joint_trajectory_controller_handle.hpp</span><a class="headerlink" href="#id2" title="このコードへのパーマリンク">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * @file follow_multi_dof_joint_trajectory_controller_handle.cpp</span>
<span class="cm"> * @brief Action client for ExecuteTrajectory action</span>
<span class="cm"> */</span>

<span class="cp">#ifndef MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>
<span class="cp">#define MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>

<span class="cp">#include</span> <span class="cpf">&lt;moveit_simple_controller_manager/action_based_controller_handle.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">dronedoc</span>
<span class="p">{</span>
<span class="cm">/**</span>
<span class="cm"> * @brief Controller for multi DOF joint trajectory</span>
<span class="cm"> *</span>
<span class="cm"> * This is generally used for arms, but could also be used for multi-dof hands,</span>
<span class="cm"> * or anything using a control_mgs/FollowJointTrajectoryAction.</span>
<span class="cm"> */</span>
<span class="k">class</span> <span class="nc">FollowMultiDOFJointTrajectoryControllerHandle</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Constructor</span>
<span class="cm">   * @param name</span>
<span class="cm">   * @param action_ns</span>
<span class="cm">   */</span>
  <span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">action_ns</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">ActionBasedControllerHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">action_ns</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Send ExecuteTrajectoryGoal message to action server</span>
<span class="cm">   * @param trajectory Trajectory to follow</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">sendTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">trajectory</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;new trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_action_client_</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trajectory</span><span class="p">.</span><span class="n">joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;%s cannot execute trajectories(trajectory_msgs/JointTrajectory).&quot;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">done_</span><span class="p">)</span>
      <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;sending trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nf">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span>
                             <span class="s">&quot;sending continuation for the currently executed trajectory to &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span><span class="p">);</span>

    <span class="c1">// Send ExecuteTrajectoryGoal message</span>
    <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoal</span> <span class="n">goal</span><span class="p">;</span>
    <span class="n">goal</span><span class="p">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">;</span>
    <span class="n">controller_action_client_</span><span class="o">-&gt;</span><span class="n">sendGoal</span><span class="p">(</span>
        <span class="n">goal</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerDoneCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerActiveCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
        <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerFeedbackCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
    <span class="n">done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">last_exec_</span> <span class="o">=</span> <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">ExecutionStatus</span><span class="o">::</span><span class="n">RUNNING</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Cancel trajecotry execution</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">cancelExecution</span><span class="p">()</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="c1">// do whatever is needed to cancel execution</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Wait trajectory execution</span>
<span class="cm">   * @param duration</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">waitForExecution</span><span class="p">(</span><span class="k">const</span> <span class="n">ros</span><span class="o">::</span><span class="n">Duration</span><span class="o">&amp;</span> <span class="n">duration</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="c1">// wait for the current execution to finish</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when server complete action</span>
<span class="cm">   * @param state</span>
<span class="cm">   * @param result</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerDoneCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleClientGoalState</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">,</span>
                              <span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResultConstPtr</span><span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Output custom error message for FollowJointTrajectoryResult if necessary</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ROS_INFO_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFTrajectoryContoller&quot;</span><span class="p">,</span> <span class="s">&quot;Execution Succeeded.&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;Returned Error Code %d&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
        <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;For Detailse of Error Code, see moveit_msgs/MoveItErrorCodes.msg&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_STREAM</span><span class="p">(</span><span class="s">&quot;Controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: no result returned&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">finishControllerExecution</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when goal become active</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerActiveCallback</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">ROS_DEBUG_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; started execution&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Called when feedback arrived from server</span>
<span class="cm">   * @param feedback</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">controllerFeedbackCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryFeedbackConstPtr</span><span class="o">&amp;</span> <span class="n">feedback</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}</span>  <span class="c1">// end namespace dronedoc</span>

<span class="cp">#endif </span><span class="c1">// MOVEIT_PLUGINS_FOLLOW_MULTI_DOF_TRAJECTORY_CONTROLLER_HANDLE</span>
</pre></div>
</td></tr></table></div>
</div>
<p>このインターフェースの実装は <a class="reference external" href="https://github.com/ros-planning/moveit/blob/f805328aefed52335558c3ea1a72937f235378fd/moveit_plugins/moveit_simple_controller_manager/include/moveit_simple_controller_manager/follow_joint_trajectory_controller_handle.h">FollowJointTrajectory</a> を参考にしています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;moveit_simple_controller_manager/action_based_controller_handle.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit_msgs/ExecuteTrajectoryAction.h&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>必要なヘッダファイルをインクルードします。
FollowMultiDOFJointTrajectoryインターフェースは、<a class="reference external" href="http://docs.ros.org/api/moveit_msgs/html/action/ExecuteTrajectory.html">ExecuteTrajectory</a> アクションを使用します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">dronedoc</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dronedoc</span></code> 名前空間を使用します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FollowMultiDOFJointTrajectoryControllerHandle</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandle</span><span class="o">&lt;</span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryAction</span><span class="o">&gt;</span>
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/ros-planning/moveit/blob/f805328aefed52335558c3ea1a72937f235378fd/moveit_plugins/moveit_simple_controller_manager/include/moveit_simple_controller_manager/action_based_controller_handle.h">ActionBasedControllerHandle</a> を継承したクラスを定義します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">sendTrajectory</span><span class="p">(</span><span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">RobotTrajectory</span><span class="o">&amp;</span> <span class="n">trajectory</span><span class="p">)</span> <span class="k">override</span>
</pre></div>
</div>
<p>動作を実行する際には、MoveIt!に登録されたインターフェースの <code class="docutils literal notranslate"><span class="pre">sendTrajectory</span></code> 関数が、<a class="reference external" href="https://github.com/ros-planning/moveit/blob/a1b0efb855af5798d62c4c450e06234abe670bd2/moveit_ros/planning/trajectory_execution_manager/src/trajectory_execution_manager.cpp#L470">TrajectoryExecutionManagerによってコール</a> されます。
このときに経路の情報（ <a class="reference external" href="http://docs.ros.org/kinetic/api/moveit_msgs/html/msg/RobotTrajectory.html">moveit_msgs/RobotTrajectory</a> メッセージ）が与えられるので、これをアクションのゴールとして送信します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">trajectory</span><span class="p">.</span><span class="n">joint_trajectory</span><span class="p">.</span><span class="n">points</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectoryController&quot;</span><span class="p">,</span> <span class="s">&quot;%s cannot execute trajectories(trajectory_msgs/JointTrajectory).&quot;</span><span class="p">,</span> <span class="n">name_</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">joint_trajectory</span></code> フィールドに経由点が格納されている場合は、実行されない旨の警告を表示します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryGoal</span> <span class="n">goal</span><span class="p">;</span>
<span class="n">goal</span><span class="p">.</span><span class="n">trajectory</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">;</span>
</pre></div>
</div>
<p>アクションサーバに送信するためのメッセージを作成します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">controller_action_client_</span><span class="o">-&gt;</span><span class="n">sendGoal</span><span class="p">(</span>
    <span class="n">goal</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerDoneCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">_2</span><span class="p">),</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerActiveCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">::</span><span class="n">controllerFeedbackCallback</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="n">_1</span><span class="p">));</span>
</pre></div>
</div>
<p>アクションサーバにゴールを送信します。
同時に、種々のコールバック関数を登録します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">controllerDoneCallback</span><span class="p">(</span><span class="k">const</span> <span class="n">actionlib</span><span class="o">::</span><span class="n">SimpleClientGoalState</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">ExecuteTrajectoryResultConstPtr</span><span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Output custom error message for FollowJointTrajectoryResult if necessary</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">moveit_msgs</span><span class="o">::</span><span class="n">MoveItErrorCodes</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">ROS_INFO_NAMED</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFTrajectoryContoller&quot;</span><span class="p">,</span> <span class="s">&quot;Execution Succeeded.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;Returned Error Code %d&quot;</span><span class="p">,</span> <span class="n">result</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
            <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;For Detailse of Error Code, see moveit_msgs/MoveItErrorCodes.msg&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">ROS_WARN_STREAM</span><span class="p">(</span><span class="s">&quot;Controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name_</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;: no result returned&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">finishControllerExecution</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>アクションサーバが実行を終了した場合に呼ばれます。
エラーが発生した場合はエラーメッセージを、成功したら成功したことを通知するメッセージを表示します。</p>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018, Takaki Ueno.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>