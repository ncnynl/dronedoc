

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>コード解説（マネージャ) &mdash; Dronedoc 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  
    <link rel="canonical" href="https://uenota.github.io/dronedoc/moveit/drive_drone/ctrl_manager.html" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Dronedoc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SLAM</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../px4sim/px4sim.html">PX4 SITL Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodecpp.html">自作ノードを実行する（C++）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../runnode/runnodepy.html">自作ノードを実行する（Python）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../addmodel/addmodel.html">新しいモデルを追加する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/slam.html">自律飛行とSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/gps_nav.html">GPSを用いた自律飛行</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/turtle_mapping.html">Turtlebotを使ってマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../teleop/teleop.html">ゲームパッドを使ってドローンを操作する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_localization.html">LiDARとAMCLを用いた自己位置推定</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/localization_and_mapping.html">LiDARを用いたSLAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slam/lidar_nav.html">LiDARを用いた自律移動</a></li>
</ul>
<p class="caption"><span class="caption-text">Mapping</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../octomap/octomap.html">Octomapを使って3Dマップを作る</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gmapping/build_map_gmapping.html">Gmappingを使って地図を生成する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../build_map_gazebo_plugin/build_map_gazebo_plugin.html">Gazebo Pluginを使って地図を作成する</a></li>
</ul>
<p class="caption"><span class="caption-text">Motion Planning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Perform motion planning of UAV with MoveIt!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../local_planner_for_uav/local_planner_for_uav.html">UAV用のローカルプランナを実装する</a></li>
</ul>
<p class="caption"><span class="caption-text">Tips</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../qgc_intro/qgc_intro.html">QGroundControl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../add_range_sensor/add_range_sensor.html">ドローンに距離センサを搭載する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filter_lidar/filter_lidar.html">LiDARのデータをフィルタリングする</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../change_local_planner/change_local_planner.html">move_baseのローカルプランナーを変更する</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../airsim/airsim.html">AirSimシミュレータを使う</a></li>
</ul>
<p class="caption"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/bash_commands/bash_commands.html">基本的なBashの使い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/ros/ros.html">ROSの基本</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/terms/terms.html">用語集</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/archive/archive.html">読書案内</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix/trouble_shooting/index.html">トラブルシューティング</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dronedoc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>コード解説（マネージャ)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/moveit/drive_drone/ctrl_manager.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>コード解説（マネージャ)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">moveit_multi_dof_controller_manager.cpp</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * @file moveit_multi_dof_controller_manager.cpp</span>
<span class="cm"> * @brief Controller manager for multi DOF joint</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit/controller_manager/controller_manager.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dronedoc/follow_multi_dof_joint_trajectory_controller_handle.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/JointState.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pluginlib/class_list_macros.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">dronedoc</span>
<span class="p">{</span>

<span class="k">class</span> <span class="nc">MoveItMultiDOFControllerManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Default constructor</span>
<span class="cm">   */</span>
  <span class="n">MoveItMultiDOFControllerManager</span><span class="p">()</span> <span class="o">:</span> <span class="n">node_handle_</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Error if controller_list param is not set</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_handle_</span><span class="p">.</span><span class="n">hasParam</span><span class="p">(</span><span class="s">&quot;controller_list&quot;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;No controller_list specified.&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span> <span class="n">controller_list</span><span class="p">;</span>
    <span class="n">node_handle_</span><span class="p">.</span><span class="n">getParam</span><span class="p">(</span><span class="s">&quot;controller_list&quot;</span><span class="p">,</span> <span class="n">controller_list</span><span class="p">);</span>

    <span class="c1">// Error if controller_list is not an array</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span> <span class="o">!=</span> <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span><span class="o">::</span><span class="n">TypeArray</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;Parameter controller_list should be specified as an array&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Error if multiple controller is defined</span>
    <span class="k">if</span><span class="p">(</span><span class="n">controller_list</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;This controller manager expects only one controller.&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Error if controller not have required fields</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;joints&quot;</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Name and joints must be specifed for each controller&quot;</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;name&quot;</span><span class="p">]);</span>

      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">action_ns</span><span class="p">;</span>

      <span class="c1">// Warn if controller has &quot;ns&quot; field</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;ns&quot;</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">action_ns</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;ns&quot;</span><span class="p">]);</span>
        <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Use of &#39;ns&#39; is deprecated, use &#39;action_ns&#39; instead.&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="c1">// Set action namespace</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;action_ns&quot;</span><span class="p">))</span>
        <span class="n">action_ns</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;action_ns&quot;</span><span class="p">]);</span>
      <span class="k">else</span> <span class="c1">// Warn if &quot;action_ns&quot; not specified</span>
        <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Please note that &#39;action_ns&#39; no longer has a default value.&quot;</span><span class="p">);</span>

      <span class="c1">// Error if &quot;joints&quot; field is not array</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">].</span><span class="n">getType</span><span class="p">()</span> <span class="o">!=</span> <span class="n">XmlRpc</span><span class="o">::</span><span class="n">XmlRpcValue</span><span class="o">::</span><span class="n">TypeArray</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;The list of joints for controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span>
                                                                               <span class="o">&lt;&lt;</span> <span class="s">&quot; is not specified as an array&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Error if controller not have &quot;type&quot; field</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;type&quot;</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;No type specified for controller &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;type&quot;</span><span class="p">]);</span>

      <span class="c1">// Set controller handle if &quot;type&quot; is FollowMultiDOFJointTrajectory</span>
      <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandleBasePtr</span> <span class="n">new_handle</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">new_handle</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">action_ns</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">new_handle</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">isConnected</span><span class="p">())</span>
        <span class="p">{</span>
          <span class="n">ROS_INFO_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Added FollowJointTrajectory controller for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">);</span>
          <span class="n">controller_</span> <span class="o">=</span> <span class="n">new_handle</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Unknown controller type: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">type</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* add list of joints, used by controller manager and MoveIt! */</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">].</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">controller_</span><span class="o">-&gt;</span><span class="n">addJoint</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;joints&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(...)</span>
    <span class="p">{</span>
      <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Caught unknown exception while parsing controller information&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Destructor</span>
<span class="cm">   */</span>
  <span class="o">~</span><span class="n">MoveItMultiDOFControllerManager</span><span class="p">()</span> <span class="k">override</span>
  <span class="p">{</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Returns pointer to controller handle</span>
<span class="cm">   * @param name</span>
<span class="cm">   */</span>
  <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span> <span class="n">getControllerHandle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">controller_</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Add FollowMultiDOFJointTrajectory to controller list</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * This manager only deals FollowMultiDOFJointTrajectory controller</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getControllersList</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get all controllers</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * This plugin assumes that all controllers are already active -- and if they are not, well, it has no way to deal</span>
<span class="cm">   * with it anyways!</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getActiveControllers</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">getControllersList</span><span class="p">(</span><span class="n">names</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get all controllers</span>
<span class="cm">   * @param names</span>
<span class="cm">   *</span>
<span class="cm">   * Controller must be loaded to be active, see comment above about active controllers...</span>
<span class="cm">   */</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">getLoadedControllers</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">names</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">getControllersList</span><span class="p">(</span><span class="n">names</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get the list of joints that a controller can control.</span>
<span class="cm">   * @param name Controller name</span>
<span class="cm">   * @param joints List of joints</span>
<span class="cm">   */</span>
  <span class="kt">void</span> <span class="n">getControllerJoints</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">joints</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">controller_</span><span class="o">-&gt;</span><span class="n">getJoints</span><span class="p">(</span><span class="n">joints</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">ROS_WARN_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;The joints for controller &#39;%s&#39; are not known. Perhaps the controller configuration is &quot;</span>
                                <span class="s">&quot;not loaded on the param server?&quot;</span><span class="p">,</span>
                     <span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
      <span class="n">joints</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Get state of controller specified by name</span>
<span class="cm">   * @param name</span>
<span class="cm">   *</span>
<span class="cm">   * Controllers are all active and default.</span>
<span class="cm">   */</span>
  <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="o">::</span><span class="n">ControllerState</span>
  <span class="n">getControllerState</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="o">::</span><span class="n">ControllerState</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">active_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">state</span><span class="p">.</span><span class="n">default_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * @brief Switch controllers</span>
<span class="cm">   * @param activate</span>
<span class="cm">   * @param deactivate</span>
<span class="cm">   *</span>
<span class="cm">   * Cannot switch our controllers</span>
<span class="cm">   */</span>
  <span class="kt">bool</span> <span class="n">switchControllers</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">activate</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">deactivate</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span> <span class="n">node_handle_</span><span class="p">;</span>
  <span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandleBasePtr</span> <span class="n">controller_</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span>  <span class="c1">// end namespace dronedoc</span>

<span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">dronedoc</span><span class="o">::</span><span class="n">MoveItMultiDOFControllerManager</span><span class="p">,</span>
                       <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
<p>このマネージャの実装は <a class="reference external" href="https://github.com/ros-planning/moveit/blob/f805328aefed52335558c3ea1a72937f235378fd/moveit_plugins/moveit_simple_controller_manager/src/moveit_simple_controller_manager.cpp">MoveItSimpleControllerManager</a> を参考にしています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;ros/ros.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;moveit/controller_manager/controller_manager.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dronedoc/follow_multi_dof_joint_trajectory_controller_handle.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sensor_msgs/JointState.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pluginlib/class_list_macros.hpp&gt;</span><span class="cp"></span>
</pre></div>
</div>
<p>必要なヘッダファイルをインクルードします。
<code class="docutils literal notranslate"><span class="pre">follow_multi_dof_joint_trajectory_controller_handle.hpp</span></code> ヘッダは、 <code class="docutils literal notranslate"><span class="pre">FollowMultiDOFJointTrajectory</span></code> インターフェースを定義しています。
また、MoveIt!のコントローラマネージャは、<a class="reference external" href="http://wiki.ros.org/pluginlib">pluginlib</a> を用いてプラグインとして登録して使用するので、pluginlibのヘッダをインクルードします。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">dronedoc</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dronedoc</span></code> 名前空間を使用します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MoveItMultiDOFControllerManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span>
</pre></div>
</div>
<p>プラグインとして利用するためには、特定のベースクラスを継承したクラスを定義する必要があります。
コントローラマネージャをMoveIt!のプラグインとして登録するためには <a class="reference external" href="http://docs.ros.org/jade/api/moveit_core/html/classmoveit__controller__manager_1_1MoveItControllerManager.html">moveit_controller_manager::MoveItControllerManager</a> クラスを継承して、メソッドをオーバーライドする必要があります。</p>
<p>プラグインの作成の詳細については、<a class="reference external" href="http://wiki.ros.org/pluginlib/Tutorials/Writing%20and%20Using%20a%20Simple%20Plugin">Writing and Using a Simple Plugin</a> を参照してください。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="p">(</span><span class="n">controller_list</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">ROS_ERROR</span><span class="p">(</span><span class="s">&quot;This controller manager expects only one controller.&quot;</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>このマネージャでは複数のコントローラを使用することは想定していないので、 <code class="docutils literal notranslate"><span class="pre">controller_list</span></code> パラメータに複数のコントローラが指定されている場合にはエラーメッセージを表示します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">controller_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hasMember</span><span class="p">(</span><span class="s">&quot;joints&quot;</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">ROS_ERROR_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Name and joints must be specifed for each controller&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">controller_list</span></code> パラメータに必要なフィールドが設定されていない場合にはエラーメッセージを表示します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">moveit_simple_controller_manager</span><span class="o">::</span><span class="n">ActionBasedControllerHandleBasePtr</span> <span class="n">new_handle</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;FollowMultiDOFJointTrajectory&quot;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">new_handle</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">action_ns</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">FollowMultiDOFJointTrajectoryControllerHandle</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">new_handle</span><span class="p">.</span><span class="n">get</span><span class="p">())</span><span class="o">-&gt;</span><span class="n">isConnected</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">ROS_INFO_STREAM_NAMED</span><span class="p">(</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;Added FollowJointTrajectory controller for &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">name</span><span class="p">);</span>
        <span class="n">controller_</span> <span class="o">=</span> <span class="n">new_handle</span><span class="p">;</span>
</pre></div>
</div>
<p>コントローラインターフェースのタイプが <code class="docutils literal notranslate"><span class="pre">FollowMultiDOFJointTrajectory</span></code> には新しくコントローラインターフェースを登録します。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span> <span class="n">getControllerHandle</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">)</span> <span class="k">override</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerHandlePtr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">controller_</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>コントローラインターフェースへのポインタを返す関数です。
コントローラインターフェースへのポインタを親クラスへのポインタへキャストして返しています。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">PLUGINLIB_EXPORT_CLASS</span><span class="p">(</span><span class="n">dronedoc</span><span class="o">::</span><span class="n">MoveItMultiDOFControllerManager</span><span class="p">,</span>
                       <span class="n">moveit_controller_manager</span><span class="o">::</span><span class="n">MoveItControllerManager</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">PLUGINLIB_EXPORT_CLASS</span></code> マクロを使ってクラスをプラグインとして登録します。
第一引数には定義したクラスを、第二引数にはベースクラスを与えます。</p>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018, Takaki Ueno.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>